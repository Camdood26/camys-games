<!DOCTYPE html>
<html>
<head>
<title>Alien Invaders â€” Touch + Game Over</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">

<style>
  html,body{
    height:100%;
    margin:0;
    background:#000;
    color:#fff;
    font-family:system-ui,Arial;
    overflow:hidden;
  }

  #ui{
    position:absolute;
    left:12px;
    top:8px;
    font-size:18px;
    z-index:30;
  }

  canvas{
    display:block;
    margin:48px auto 0;
    background:#191919;
    border:0;
  }

  /* TOUCH CONTROLS */
  #touch-controls {
    position: fixed;
    bottom: 18px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 18px;
    z-index: 40;
    pointer-events: auto;
  }

  .tc-btn {
    width: 86px;
    height: 86px;
    font-size: 36px;
    border-radius: 16px;
    border: none;
    background: rgba(255,255,255,0.14);
    color: #fff;
    -webkit-user-select:none;
    user-select:none;
    touch-action: none;
    display:flex;
    align-items:center;
    justify-content:center;
    box-shadow: 0 6px 18px rgba(0,0,0,0.6);
  }
  .tc-btn.active { background: rgba(255,255,255,0.28); transform: translateY(2px); }

  @media (pointer:fine) { #touch-controls { display:none; } }

  /* DARK GAME OVER PANEL â€” SAFARI SAFE (NO BLUR) */
  #gameover-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.9); /* solid dark instead of blur */
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }

  #gameover-panel {
    background: rgba(30,30,40,0.9);
    border: 2px solid rgba(255,0,0,0.4);
    box-shadow: 0 0 25px rgba(255,0,0,0.6);
    padding: 28px 40px;
    border-radius: 14px;
    text-align: center;
    width: 320px;
  }

  #go-title {
    font-size: 36px;
    margin-bottom: 10px;
    color: #ff3333;
    text-shadow: 0 0 10px #ff0000;
    font-weight: bold;
  }

  #go-score {
    margin-bottom: 25px;
    font-size: 20px;
    color: #ddd;
  }

  .go-btn {
    width: 100%;
    padding: 12px;
    margin-top: 10px;
    border: none;
    border-radius: 8px;
    background: #222;
    color: #fff;
    font-size: 18px;
    cursor: pointer;
    transition: 0.2s;
  }
  .go-btn:hover { background:#333; }
</style>
</head>

<body>

<div id="ui">Score: 0<br>Level: 1</div>

<!-- Touch controls -->
<div id="touch-controls">
  <button id="btn-left" class="tc-btn">âŸµ</button>
  <button id="btn-fire" class="tc-btn">ðŸ”¥</button>
  <button id="btn-right" class="tc-btn">âŸ¶</button>
</div>

<!-- GAME OVER -->
<div id="gameover-overlay">
  <div id="gameover-panel">
    <div id="go-title">GAME OVER</div>
    <div id="go-score">Score: 0</div>
    <button class="go-btn" onclick="location.reload()">Play Again</button>
    <button class="go-btn" onclick="window.location='index.html'">Back to Home</button>
  </div>
</div>

<canvas id="gameCanvas" width="800" height="600"></canvas>

<script>
/* GAME VARIABLES */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

let score = 0;
let level = 1;
let enemies = [];
let bullets = [];
let alienBullets = [];
let boss = null;
let gameRunning = true;

let permanentPowerups = {
  fireRateBoost:0,
  speedBoost:0,
  bulletSizeBoost:0
};

const ui = document.getElementById('ui');
function updateUI(){ ui.innerHTML = `Score: ${score}<br>Level: ${level}`; }

/* PLAYER */
let player = {
  x: canvas.width/2 - 20,
  y: canvas.height - 60,
  width: 40,
  height: 40,
  speed: 5,
  cooldown: 0
};

function drawPlayer(){
  ctx.fillStyle = 'cyan';
  ctx.fillRect(player.x, player.y, player.width, player.height);
}

/* INPUT */
let keys = {};
window.addEventListener('keydown', e=>keys[e.key]=true);
window.addEventListener('keyup',   e=>keys[e.key]=false);

let touchLeft=false, touchRight=false, touchFire=false;

/* PLAYER UPDATE */
function updatePlayer(){
  const speed = player.speed + permanentPowerups.speedBoost;
  let move = 0;

  if (keys['a'] || keys['ArrowLeft']  || touchLeft)  move = -1;
  if (keys['d'] || keys['ArrowRight'] || touchRight) move = 1;

  player.x += move * speed;
  player.x = Math.max(0, Math.min(canvas.width - player.width, player.x));

  if (player.cooldown>0) player.cooldown--;

  if ((keys[' '] || keys['Space'] || touchFire) && player.cooldown==0){
    bullets.push({
      x: player.x + player.width/2 - (4 + permanentPowerups.bulletSizeBoost)/2,
      y: player.y,
      size: 4 + permanentPowerups.bulletSizeBoost,
      speed: 8
    });
    player.cooldown = Math.max(5, 20 - permanentPowerups.fireRateBoost);
  }
}

/* BULLETS */
function updateBullets(){
  for (let i=bullets.length-1;i>=0;i--){
    bullets[i].y -= bullets[i].speed;
    if (bullets[i].y < -20) bullets.splice(i,1);
  }
}

function drawBullets(){
  ctx.fillStyle='yellow';
  for (let b of bullets){
    ctx.fillRect(b.x,b.y,b.size,b.size);
  }
}

/* ALIENS */
function spawnAliens(){
  enemies = [];
  const rows = 3 + Math.floor(level/2);
  const cols = 8;
  const spacingX = 60, spacingY = 52;
  const marginLeft = Math.max(40, (canvas.width - cols*30 - (cols-1)*spacingX)/2);

  for (let r=0;r<rows;r++){
    for (let c=0;c<cols;c++){
      enemies.push({
        x: marginLeft + c*spacingX,
        y: 40 + r*spacingY,
        width:30, height:30,
        speedX: 1 + level*0.25,
        movingRight:true,
        shootChance: 0.002 + level*0.0015
      });
    }
  }
}

function updateAliens(){
  for (let i=enemies.length-1;i>=0;i--){
    const e=enemies[i];

    e.x += e.movingRight ? e.speedX : -e.speedX;

    if (e.x<0){ e.movingRight=true; e.y+=18; }
    if (e.x>canvas.width-e.width){ e.movingRight=false; e.y+=18; }

    if (Math.random()<e.shootChance){
      alienBullets.push({
        x:e.x+e.width/2-3,
        y:e.y+e.height,
        speed:4+level*0.3,
        w:6,h:10
      });
    }

    for (let bi=bullets.length-1;bi>=0;bi--){
      const b=bullets[bi];
      if (b.x<b.x+e.width && b.x+b.size>e.x &&
          b.y<e.y+e.height && b.y+b.size>e.y){
        enemies.splice(i,1);
        bullets.splice(bi,1);
        score +=10;
        updateUI();
        break;
      }
    }
  }
}

function drawAliens(){
  ctx.fillStyle='lime';
  for (let e of enemies) ctx.fillRect(e.x,e.y,e.width,e.height);
}

/* ALIEN BULLETS + GAME OVER */
const overlay=document.getElementById("gameover-overlay");
const goScore=document.getElementById("go-score");

function triggerGameOver(){
  gameRunning=false;
  goScore.textContent = "Score: "+score;
  overlay.style.display="flex";
}

function updateAlienBullets(){
  for (let i=alienBullets.length-1;i>=0;i--){
    const b=alienBullets[i];
    b.y+=b.speed;

    if (b.y>canvas.height+20){
      alienBullets.splice(i,1);
      continue;
    }

    if (b.x+(b.w||6)>player.x && b.x<player.x+player.width &&
        b.y+(b.h||10)>player.y && b.y<player.y+player.height){
      triggerGameOver();
      return;
    }
  }
}

function drawAlienBullets(){
  ctx.fillStyle='red';
  for (let b of alienBullets){
    ctx.fillRect(b.x,b.y,b.w||6,b.h||10);
  }
}

/* BOSS */
function spawnBoss(){
  boss={
    x:canvas.width/2-100,
    y:80,
    width:200, height:120,
    hp:100 + level*40,
    speed:2+level*0.2,
    direction:1,
    shootCooldown:0
  };
}

function updateBoss(){
  if (!boss) return;

  boss.x += boss.speed * boss.direction;

  if (boss.x<6){ boss.x=6; boss.direction=1; }
  if (boss.x+boss.width>canvas.width-6){
    boss.x=canvas.width-boss.width-6;
    boss.direction=-1;
  }

  if (boss.shootCooldown>0) boss.shootCooldown--;
  else {
    for (let i=0;i<3;i++){
      alienBullets.push({
        x: boss.x + boss.width*(0.2+0.3*i),
        y: boss.y + boss.height,
        speed:5+level*0.3,
        w:10,h:12
      });
    }
    boss.shootCooldown = Math.max(18, 40 - Math.min(25, level*2));
  }

  for (let bi=bullets.length-1;bi>=0;bi--){
    const b=bullets[bi];
    if (b.x<boss.x+boss.width && b.x+b.size>boss.x &&
        b.y<boss.y+boss.height && b.y+b.size>boss.y){

      bullets.splice(bi,1);
      boss.hp-=10;

      if (boss.hp<=0){
        givePermanentPowerup();
        score+=200;
        updateUI();
        boss=null;
        nextLevel();
        break;
      }
    }
  }
}

function drawBoss(){
  if (!boss) return;

  ctx.fillStyle="#999";
  ctx.fillRect(boss.x,boss.y,boss.width,boss.height);

  ctx.strokeStyle="#444"; ctx.lineWidth=6;
  for (let i=0;i<4;i++){
    ctx.beginPath();
    ctx.moveTo(boss.x+20+i*40, boss.y+boss.height);
    ctx.lineTo(boss.x+6+i*40, boss.y+boss.height+38);
    ctx.stroke();
  }

  ctx.fillStyle='red';
  ctx.fillRect(boss.x,boss.y-10,boss.width,8);

  ctx.fillStyle='green';
  let hpW=Math.max(0,boss.hp/(100+level*40)*boss.width);
  ctx.fillRect(boss.x,boss.y-10,hpW,8);
}

/* POWERUPS */
function givePermanentPowerup(){
  const r=Math.floor(Math.random()*3);
  if (r==0) permanentPowerups.fireRateBoost+=5;
  if (r==1) permanentPowerups.speedBoost+=0.5;
  if (r==2) permanentPowerups.bulletSizeBoost+=2;
  alert("Boss defeated! Permanent upgrade gained!");
}

function nextLevel(){
  level++;
  updateUI();

  if (level % 5 === 0) spawnBoss();
  else spawnAliens();
}

/* MAIN LOOP */
function gameLoop(){
  if (!gameRunning) return;

  ctx.clearRect(0,0,canvas.width,canvas.height);

  updatePlayer();
  drawPlayer();

  updateBullets();
  drawBullets();

  updateAlienBullets();
  drawAlienBullets();

  if (boss){
    updateBoss();
    drawBoss();
  } else {
    updateAliens();
    drawAliens();
  }

  if (!boss && enemies.length==0) nextLevel();

  requestAnimationFrame(gameLoop);
}

/* TOUCH BINDINGS */
function bind(btn, down, up){
  btn.addEventListener('pointerdown', e=>{e.preventDefault();down();btn.classList.add("active");});
  btn.addEventListener('pointerup',   e=>{e.preventDefault();up();btn.classList.remove("active");});
  btn.addEventListener('pointerleave',e=>{up();btn.classList.remove("active");});
}
bind(btn-left, ()=>touchLeft=true, ()=>touchLeft=false);
bind(btn-right,()=>touchRight=true,()=>touchRight=false);
bind(btn-fire, ()=>touchFire=true, ()=>touchFire=false);

/* INIT */
spawnAliens();
updateUI();
gameLoop();
</script>

</body>
</html>
